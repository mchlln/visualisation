[{"name":"app.R","content":"library(shiny)\nlibrary(leaflet)\nlibrary(bslib)\nlibrary(arrow)\nlibrary(geosphere)\nlibrary(sf)\nlibrary(dplyr)\n\nsource(\"global.R\")\n\nsource(\"./src/ui.R\")\nsource(\"./src/server.R\")\nshinyApp(ui, server)\n","type":"text"},{"name":"README.md","content":"# Fouille Extraction Visualisation\n\n## Ressources\n\n- [Jeu de donnée: data.gouv](https://www.data.gouv.fr/datasets/donnees-sur-la-localisation-et-lacces-de-la-population-aux-equipements/)\n- [Légende des équipements utilisés](https://www.insee.fr/fr/metadonnees/source/operation/s2216/presentation)\n- [Légende des équipements utilisés (CSV)](https://www.insee.fr/fr/metadonnees/source/fichier/BPE24_table_passage.csv)\n- [Données sur les dépenses culturelles](https://www.data.gouv.fr/datasets/depenses-culturelles-des-communes/)\n- [Données sur les dépenses en santé](https://www.data.gouv.fr/datasets/open-damir-base-complete-sur-les-depenses-dassurance-maladie-interregimes)\n\n## Idées:\n\n- Identifier les zones les plus isolées, les plus denses en équipement\n- Voir s'il y a une corrélation entre l'éloignement à des services de santé et les dépenses en santé des habitants.\n- Distance avec les équipements et rapport avec le salaire moyen des habitants\n- Voir s'il y a une liaison entre la présence d'établissements d'éduction supérieure et de certains types d'équipements\n- Est-ce que les communes qui ont peu d'établissements culturels dépensent moins en budget culturel par habitant que celles avec beaucoup d'établissments culturels\n- Est-ce que les dépenses en culture augmentent plus on se trouve proche d'un équipement culturel\n- Quel équipement fait le plus grimper le prix de l'immobilier\n- Types d'équipement en fonction de la densité : est-ce qu'à partir d'une certaine densité, on retrouve certains équipements plus proches\n- Quel est le sport le plus accessible selon l'endroit de vie (terrains de foot + présents à la campagne/périphérie, salle de sport en centre ville)\n- Une ville qui dépense plus a des haibtants plus proches de lieux pour la culture ?\n\n## Technique\n\n- R\n- PostGreSQL pour nos données : peut être distant, possibilité de faire des opérations SQL\n- package arrow pour gérer les .parquet\n- dplyr pour faire un workflow lazy (execution seulement quand on le demande et directement sur disque)\n- Shiny pour faire de l'interractif\n\n## Project Set-up\n\n### Linux\n\n#### Conda + Shiny App\n- Run `wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh` to download MiniConda installer\n- Run `bash Miniconda3-latest-Linux-x86_64.sh`\n- Follow installer instructions\n- Create environment:\n  - For runtime: `conda env create -f environment.yml`\n  - For development: `conda env create -f environment-dev.yml` (r-studio-desktop included)\n- run `conda activate shiny-visualisation` to load the environment\n- run `R -e \"shiny::runApp('./')\"` to run the App\n\n#### Database (docker)\n- run `docker compose up -d` to start the container\n- run `docker compose down -v` to stop and clean container","type":"text"},{"name":"docker-compose.yml","content":"version: '3.8'\n\nservices:\n  db:\n    image: postgres:16-alpine\n    container_name: postgres_db\n    restart: always\n    \n    environment:\n      POSTGRES_USER: visualisation\n      POSTGRES_PASSWORD: visualisation\n      POSTGRES_DB: shiny_db\n      \n    ports:\n      - \"5432:5432\"\n      \n    volumes:\n      - pg_data:/var/lib/postgresql/data \n\nvolumes:\n  pg_data:","type":"text"},{"name":"environment-dev.yml","content":"name: shiny-visualisation\nchannels:\n  - conda-forge\ndependencies:\n  - r-base\n  - r-shiny\n  - r-dplyr\n  - r-dbplyr\n  - r-dbi\n  - r-rpostgres\n  - r-leaflet\n  - r-bslib\n  - r-arrow\n  - r-geosphere\n  - r-sf\n  - rstudio-desktop","type":"text"},{"name":"environment.yml","content":"name: shiny-visualisation\nchannels:\n  - conda-forge\ndependencies:\n  - r-base\n  - r-shiny\n  - r-dplyr\n  - r-dbplyr\n  - r-dbi\n  - r-rpostgres\n  - r-leaflet\n  - r-bslib\n  - r-arrow\n  - r-geosphere\n  - r-sf","type":"text"},{"name":"global.R","content":"library(DBI)\nlibrary(RPostgres)\n\ndb_host <- Sys.getenv(\"DB_HOST\")\ndb_port <- Sys.getenv(\"DB_PORT\")\ndb_name <- Sys.getenv(\"DB_NAME\")\ndb_user <- Sys.getenv(\"DB_USER\")\ndb_password <- Sys.getenv(\"DB_PASSWORD\")\n\ntryCatch({\n    conn <- dbConnect(\n        RPostgres::Postgres(),\n            dbname = Sys.getenv(\"DB_NAME\", \"shiny_db\"),\n            host = Sys.getenv(\"DB_HOST\", \"127.0.0.1\"),\n            port = Sys.getenv(\"DB_PORT\", 5432),\n            user = Sys.getenv(\"DB_USER\", \"visualisation\"),\n            password = Sys.getenv(\"DB_PASSWORD\", \"visualisation\")\n    )\n    message(\"Connected successfully\")\n\n    \n\n    is_empty <- function(con, table) {\n        tryCatch({\n            query <- sprintf(\"SELECT COUNT(*) AS n FROM %s;\", table)\n            n <- dbGetQuery(con, query)$n\n            return(n == 0)}, \n            error = function(e){return (TRUE)})\n        \n    }\n\n    if(is_empty(conn, \"equipment_access\")){\n        message(\"Reading Parquet file...\")\n        df <- read_parquet(\"data/donnees-2024-reg94.parquet\")\n        df_data_frame <- as.data.frame(df)\n        message(\"Writing to Database...\")\n        dbWriteTable(conn, \"equipment_access\", df_data_frame, overwrite = TRUE, row.names = FALSE)\n        message(\"Success! Data loaded.\")\n    }else{\n        message(\"Database already loaded, skipping data load\")\n    }\n    \n    legend <- read.csv(file = \"data/BPE24_table_passage.csv\", sep = \";\", header = T)\n    print(legend)\n    \n    #dbDisconnect(conn)\n\n}, error = function(e) {\n    message(\"DB ERROR: \", e$message)\n})","type":"text"},{"name":"src/server.R","content":"library(shiny)\n\nfetchDB <- function(input) {\n    north_lat <- input$map_background$north\n    south_lat <- input$map_background$south\n    leafletProxy(\"map_background\") %>% clearMarkers() %>% clearShapes() \n    \n    df <- data.frame(c(input$map_background_bounds$west, input$map_background_bounds$east), c(input$map_background_bounds$north, input$map_background_bounds$south))\n    colnames(df) <- c(\"X\", \"Y\")\n\n    data_sf_orig <- st_as_sf(\n        df,\n        coords = c(\"X\", \"Y\"),\n        crs = 4326\n    )\n\n    data_sf_3035 <- st_transform(data_sf_orig, 3035)\n\n    coords_3035 <- st_coordinates(data_sf_3035)\n    x_min <- min(coords_3035[, 1])\n    x_max <- max(coords_3035[, 1])\n    y_min <- min(coords_3035[, 2])\n    y_max <- max(coords_3035[, 2])\n    \n    max_fetch <- input$slider\n\n    res <- dbSendQuery(conn, sprintf(\"SELECT * FROM equipment_access WHERE \\\"X\\\" >= %.0f AND \\\"X\\\" <= %.0f AND \\\"Y\\\" >= %.0f AND \\\"Y\\\" <= %.0f LIMIT %.0f\", x_min, x_max, y_min, y_max, max_fetch))\n    f <- dbFetch(res)\n\n    if (nrow(f) == 0){\n      print(\"No squared referenced in this area\")\n      return ()\n    }\n\n    data_sf_4326 <- dbCoordsToLeaflet(f)\n\n    \n    for (elt2 in seq_len(nrow(data_sf_4326))){\n        elt <- data_sf_4326[elt2, ]\n\n        #leafletProxy(\"map_background\") %>% addMarkers(\n        #lng = st_coordinates(elt)[,1],\n        #lat = st_coordinates(elt)[,2],\n        #label = elt$Label\n        #)\n        bottomRightPoint <- destPoint(st_coordinates(elt)[1,], 135, sqrt(2)*100)\n        topLeftPoint <- destPoint(st_coordinates(elt)[1,], 315, sqrt(2)*100)\n        leafletProxy(\"map_background\") %>% addRectangles(\n        lng1=topLeftPoint[1],\n        lat1=topLeftPoint[2],\n        lng2=bottomRightPoint[1],\n        lat2=bottomRightPoint[2],\n        color=\"green\",\n        label = elt$Label\n        )\n\n    }\n}\n\nselectSquare <- function(input, plot_data_rv, selected_point_rv, table_data_rv){\n  click_pos <-input$map_background_click\n  \n  df <- data.frame(click_pos$lng, click_pos$lat)\n  colnames(df) <- c(\"X\", \"Y\")\n  \n  data_sf_orig <- st_as_sf(\n    df,\n    coords = c(\"X\", \"Y\"),\n    crs = 4326\n  )\n  \n  data_sf_3035 <- st_transform(data_sf_orig, 3035)\n  \n  coords_3035 <- st_coordinates(data_sf_3035)\n  \n  x<-coords_3035[1, 1]\n  y<-coords_3035[1, 2]\n  \n  x_range_min <- x - 100\n  x_range_max <- x + 100\n  y_range_min <- y - 100\n  y_range_max <- y + 100\n  \n  query <- sprintf(\"\n  SELECT *, \n         SQRT(POW(\\\"X\\\" - %.0f, 2) + POW(\\\"Y\\\" - %.0f, 2)) AS calculated_distance\n  FROM equipment_access\n  WHERE \\\"X\\\" BETWEEN %.0f AND %.0f AND \\\"Y\\\" BETWEEN %.0f AND %.0f\n  ORDER BY calculated_distance ASC\n  LIMIT 1\", \n  x, y, x_range_min, x_range_max, y_range_min, y_range_max)\n  \n  \n\n  res <- dbSendQuery(conn, query)\n  nearest_point <- dbFetch(res)\n  \n  if (nrow(nearest_point) == 0){\n    print(\"No data for given area\")\n    leafletProxy(\"map_background\") %>% clearMarkers()\n    return ()\n  }\n  \n  selected_point_rv(nearest_point)\n  \n  query <- sprintf(\"SELECT * FROM equipment_access WHERE \\\"X\\\" = %.0f AND \\\"Y\\\" = %.0f ORDER BY distance ASC\", nearest_point$X, nearest_point$Y)\n  res <- dbSendQuery(conn, query)\n  tableData <- dbFetch(res)\n  table_data_rv(tableData)\n  \n  # TODO: after merge call find square to link plots to user selection\n  findSquare(data.frame(X=nearest_point$X, Y=nearest_point$Y), input, plot_data_rv)\n  data_sf_4326 <- dbCoordsToLeaflet(nearest_point)\n  leafletProxy(\"map_background\") %>% clearMarkers() %>% addMarkers(\n    lng = st_coordinates(data_sf_4326)[1,1],\n    lat = st_coordinates(data_sf_4326)[1,2],\n  )\n}\n\n\ndbCoordsToLeaflet <- function(df){\n    data_df_orig <- data.frame(\n        X = df$X,\n        Y = df$Y,\n        Label = df$pop\n    ) %>% distinct()\n\n    data_sf_orig <- st_as_sf(\n        data_df_orig,\n        coords = c(\"X\", \"Y\"),\n        crs = 3035\n    )\n\n    data_sf_4326 <- st_transform(data_sf_orig, 4326)\n\n    return (data_sf_4326)\n\n}\n\nfindSquare<- function(point, input, plot_data_rv){\n  eq <- input$selectEquimpent\n  if(eq == \".\"){\n    eq <- \"\"\n  }\n  equipment_type <- dbQuoteString(conn, paste0(eq, \"%\"))\n  \n  if(is.null(point) || nrow(point) == 0) {\n    plot_data_rv(data.frame())\n    return()\n  }\n\n  res <- dbSendQuery(conn, sprintf(\"SELECT * FROM equipment_access WHERE \\\"X\\\" = %.0f AND \\\"Y\\\" = %.0f AND \\\"typeeq_id\\\" LIKE %s\",\n                                   point$X, point$Y, equipment_type))\n  plot_data_rv(dbFetch(res))\n  dbClearResult(res)\n}\n\nserver <- function(input, output) {\n\n    plot_data <- reactiveVal(data.frame())\n    table_data <- reactiveVal(data.frame())\n    selected_point <- reactiveVal(NULL)\n\n    observeEvent(input$map_background_click, {\n      selectSquare(input, plot_data, selected_point, table_data)\n    })\n\n\n    res <- dbSendQuery(conn, \"SELECT * FROM equipment_access LIMIT 10\")\n    f <- dbFetch(res)\n    print(f)\n\n    leaf <- leaflet() %>%\n                addTiles() \n\n    observeEvent(input$map_background_bounds, {\n        fetchDB(input)\n    })\n    \n\n    data_sf_4326 <- dbCoordsToLeaflet(f)\n    \n    for (elt2 in seq_len(nrow(data_sf_4326))){\n        elt <- data_sf_4326[elt2, ]\n\n        leaf <- addMarkers(\n        map = leaf,\n        lng = st_coordinates(elt)[,1],\n        lat = st_coordinates(elt)[,2],\n        label = elt$Label\n        )\n        bottomRightPoint <- destPoint(st_coordinates(elt)[1,], 135, sqrt(2)*100)\n        topLeftPoint <- destPoint(st_coordinates(elt)[1,], 315, sqrt(2)*100)\n        leaf <- addRectangles(\n        map = leaf,\n        lng1=topLeftPoint[1],\n        lat1=topLeftPoint[2],\n        lng2=bottomRightPoint[1],\n        lat2=bottomRightPoint[2],\n        color=\"green\"\n        )\n\n    }\n    observeEvent(input$selectEquimpent, {\n       if (!is.null(selected_point())) {\n         findSquare(selected_point(), input, plot_data)\n       }\n    })\n    \n    output$table <- renderTable({\n      d <- plot_data()\n      req(nrow(d) > 0)\n      d_ordered <- d[order(d$duree), ]\n      code_signification <- setNames(legend$Libelle_TYPEQU, legend$TYPEQU)\n      d_ordered$signification <- sapply(d_ordered$typeeq_id, function(x) code_signification[match(x, names(code_signification))])\n      d_ordered[,c(15,5,7)]\n    })\n\n    output$distPlot <- renderPlot({\n      f <- plot_data()\n      req(nrow(f) > 0)\n      \n      h <- hist(f$duree, col = \"#007bc2\", border = \"white\",\n                xlab = \"Duration of travel from the square to an equipment (in minutes)\",\n                ylab = \"Number of equipments\",\n                main = \"Histogram of travel time to an equipment\",\n                xaxt = \"n\",\n                yaxt = \"n\")\n      axis(1, at = seq(0, max(f$duree, na.rm = TRUE)+20, by = 20))\n      axis(2, at = seq(0,max(h$counts)+5, by = 5))\n    })\n\n   \n    print(\"Server update done!\")\n    \n    output$map_background <- renderLeaflet({leaf})\n\n}\n","type":"text"},{"name":"src/ui.R","content":"library(shiny)\n\nui <- page_sidebar(\n    title = \"Visualisation 2025\",\n    sidebar = sidebar(\n        position = \"left\",\n        sliderInput(\"slider\", label = \"Max number of areas to show\", min = 1000, max = 50000, value = 10000),\n    ),\n    navset_card_underline(\n      nav_panel(\n        title = \"General view\",\n        layout_columns(\n            card(\n                card_header(\"Map of Equipment Access\"),\n                leafletOutput(\"map_background\"),\n            ),\n            card(\n                card_header(\"Travel Time Distribution\"),\n                selectInput(\"selectEquimpent\",\n                            label=\"Select Equipment category\",\n                            choices = list(\"GLOBAL\" = \".\",\n                                           \"SERVICES POUR LES PARTICULIERS \" = \"A\",\n                                           \"COMMERCES\" = \"B\",\n                                           \"ENSEIGNEMENT\" = \"C\",\n                                           \"SANTÉ ET ACTION SOCIALE\" = \"D\",\n                                           \"TRANSPORTS ET DÉPLACEMENTS \" =\"E\",\n                                           \"SPORTS, LOISIRS ET CULTURE \"=\"F\",\n                                           \"TOURISME\"=\"G\"),\n                            selected = \".\"\n                ),\n                plotOutput(outputId = \"distPlot\"),\n                div(style = \"overflow-y: auto; height: 300px;\", tableOutput(outputId = \"table\"))\n            )\n        )\n      ),\n    nav_panel(\n      title = \"About\",\n      card(\n        card_header(\"Information\"),\n        p(\"This General view tab displays equipment access and travel time distributions across various regions.\"),\n        p(\"Other tabs containing different visualisations will be added later\"),\n        p(\"On the sidebar, you can choose to display more squares\")\n      )\n    )\n    )\n)\n\n\n","type":"text"}]
